---
import wrapped from "../data/wrapped.json";
import Poster from "../components/Poster.astro";

const { channel, stats, topVideos, topShorts, timeline } = wrapped;

function formatNum(n) {
  return n?.toLocaleString?.("es-ES") ?? n;
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>{channel.title} — Wrapped</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script
      src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
    ></script>
  </head>
  <body
    class="bg-[#fdfdfd] text-black font-sans selection:bg-yellow-300 selection:text-black"
  >
    <main class="max-w-5xl mx-auto p-6 space-y-10">
      <!-- Portada -->
      <Poster
        title={`${channel.title} Wrapped`}
        subtitle={`Una década de manga (${new Date(channel.publishedAt).getFullYear()} — ${new Date().getFullYear()})`}
        image={channel.banner}
        stats={[
          { label: "Suscriptores", value: formatNum(channel.subscribers) },
          { label: "Vistas", value: formatNum(channel.views) },
          { label: "Videos", value: formatNum(channel.videos) },
        ]}
      />

      <!-- Top Videos -->
      <section class="border-8 border-black p-6 bg-white rounded-2xl">
        <h2 class="text-3xl font-extrabold mb-4">🎬 Top Videos</h2>
        <div class="grid md:grid-cols-3 gap-4">
          {
            topVideos.map((v) => (
              <a
                href={`https://youtu.be/${v.id}`}
                target="_blank"
                class="border-4 border-black rounded-xl overflow-hidden group hover:scale-[1.02] transition-transform"
              >
                <img
                  src={v.thumbnail}
                  alt={v.title}
                  class="w-full h-40 object-cover"
                />
                <div class="p-2">
                  <p class="font-semibold text-sm">{v.title}</p>
                  <p class="text-xs opacity-80">👁 {formatNum(v.views)}</p>
                </div>
              </a>
            ))
          }
        </div>
      </section>

      <!-- Top Shorts -->
      <section class="border-8 border-black p-6 bg-white rounded-2xl">
        <h2 class="text-3xl font-extrabold mb-4">📱 Top Shorts</h2>
        <div class="grid md:grid-cols-3 gap-4">
          {
            topShorts.map((v) => (
              <a
                href={`https://youtu.be/${v.id}`}
                target="_blank"
                class="border-4 border-black rounded-xl overflow-hidden group hover:scale-[1.02] transition-transform"
              >
                <img
                  src={v.thumbnail}
                  alt={v.title}
                  class="w-full h-40 object-cover"
                />
                <div class="p-2">
                  <p class="font-semibold text-sm">{v.title}</p>
                  <p class="text-xs opacity-80">👁 {formatNum(v.views)}</p>
                </div>
              </a>
            ))
          }
        </div>
      </section>

      <!-- Insights -->
      <section class="border-8 border-black p-6 bg-white rounded-2xl">
        <h2 class="text-3xl font-extrabold mb-4">💡 Insights</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="text-xl font-bold mb-2">Palabras más usadas</h3>
            <ul class="flex flex-wrap gap-2">
              {
                stats.topWords.map((w) => (
                  <li class="px-3 py-1 border-2 border-black rounded-full bg-yellow-200 font-semibold text-sm">
                    {w.word} ({w.count})
                  </li>
                ))
              }
            </ul>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-2">Timeline</h3>
            <ul class="list-disc pl-6 text-sm space-y-1">
              {
                timeline.map((t) => (
                  <li>
                    {t.year} — {t.text}
                  </li>
                ))
              }
            </ul>
          </div>
        </div>
      </section>

      <div class="text-center py-8">
        <button
          id="capture"
          class="px-6 py-3 border-4 border-black bg-black text-white font-bold rounded-xl hover:bg-yellow-400 hover:text-black transition"
        >
          📸 Guardar Póster
        </button>
      </div>
    </main>

    <script>
      document.getElementById("capture").addEventListener("click", async () => {
        const canvas = await html2canvas(document.querySelector("main"), {
          scale: 2,
        });
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = "umaruyt-wrapped.png";
        a.click();
      });
    </script>
  </body>
</html>
